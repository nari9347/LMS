<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>LMS - Teacher Dashboard</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    body { background: #f8fafc; color: #1e293b; }
    header { background: white; padding: 1rem 2rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
    .brand { display: flex; gap: 10px; align-items: center; }
    .brand img { width: 32px; }
    .user-info { display: flex; gap: 15px; align-items: center; }
    .btn { padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; text-decoration: none; display: inline-block; }
    .btn-primary { background: #3b82f6; color: white; }
    .btn-danger { background: #ef4444; color: white; }
    .btn:hover { opacity: 0.9; }
    .container { max-width: 1200px; margin: 0 auto; padding: 2rem; }
    .section { background: white; border-radius: 12px; padding: 2rem; margin-bottom: 2rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .student-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1rem; margin-top: 1rem; }
    .student-card { background: #f1f5f9; border: 1px solid #e2e8f0; border-radius: 8px; padding: 1rem; transform: translateY(6px); opacity: 0; transition: transform .25s ease, box-shadow .25s ease; }
    .student-card:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.1); }
    .student-card h4 { color: #1e293b; margin-bottom: 0.5rem; }
    .student-card p { color: #64748b; font-size: 14px; }
    .section h2 { margin-bottom: 1.5rem; color: #1e293b; }
    .form-group { margin-bottom: 1rem; }
    .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151; }
    .form-group input, .form-group textarea { width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 16px; }
    .form-group textarea { height: 100px; resize: vertical; }
    .courses-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem; }
    .course-card { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 1.5rem; transform: translateY(6px); opacity: 0; transition: transform .25s ease, box-shadow .25s ease; }
    .course-card:hover { transform: translateY(-2px); box-shadow: 0 10px 18px rgba(0,0,0,0.08); }
    .course-card h3 { color: #1e293b; margin-bottom: 0.5rem; }
    .course-card p { color: #64748b; margin-bottom: 1rem; }
    .course-meta { display: flex; justify-content: space-between; align-items: center; font-size: 14px; color: #64748b; }
    .msg { padding: 12px; border-radius: 8px; margin-bottom: 1rem; display: none; }
    .msg.success { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
    .msg.error { background: #fef2f2; color: #dc2626; border: 1px solid #fecaca; }
    .loading { text-align: center; padding: 2rem; color: #64748b; }
    /* animations */
    .section { animation: fadeInUp .5s ease forwards; opacity: 0; transform: translateY(10px); }
    @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideInUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <img src="https://cdn-icons-png.flaticon.com/512/833/833314.png" alt="LMS">
      <strong>LMS - Teacher Dashboard</strong>
    </div>
    <div class="user-info">
      <span id="userName">Loading...</span>
      <button class="btn btn-danger" onclick="logout()">Logout</button>
    </div>
  </header>

  <div class="container">
    <div class="section">
      <h2>Create New Course</h2>
      <div id="createMsg" class="msg"></div>
      <form id="createCourseForm">
        <div class="form-group">
          <label for="title">Course Title</label>
          <input type="text" id="title" required placeholder="e.g., Introduction to Web Development">
        </div>
        <div class="form-group">
          <label for="description">Description</label>
          <textarea id="description" required placeholder="Describe what students will learn in this course..."></textarea>
        </div>
        <div class="form-group">
          <label for="duration">Duration</label>
          <input type="text" id="duration" required placeholder="e.g., 8 weeks, 3 months">
        </div>
        <button type="submit" class="btn btn-primary">Create Course</button>
      </form>
    </div>

    <div class="section">
      <h2>My Courses</h2>
      <div id="coursesMsg" class="msg"></div>
      <div id="coursesContainer" class="loading">Loading courses...</div>
    </div>
  </div>

  <script>
    let token = localStorage.getItem('token');
    let user = null;

    function requireAuth() {
      if (!token) {
        window.location.href = '/auth-ui/login.html';
        return false;
      }
      try {
        const payload = JSON.parse(atob(token.split('.')[1]));
        if (payload.role !== 'Teacher') {
          alert('Access denied. Teacher role required.');
          window.location.href = '/auth-ui/login.html';
          return false;
        }
        user = payload;
        document.getElementById('userName').textContent = user.name;
        return true;
      } catch (e) {
        localStorage.removeItem('token');
        window.location.href = '/auth-ui/login.html';
        return false;
      }
    }

    function showMsg(elementId, isSuccess, text) {
      const msg = document.getElementById(elementId);
      msg.textContent = text;
      msg.className = `msg ${isSuccess ? 'success' : 'error'}`;
      msg.style.display = 'block';
      setTimeout(() => msg.style.display = 'none', 5000);
    }

    async function createCourse(e) {
      e.preventDefault();
      const title = document.getElementById('title').value.trim();
      const description = document.getElementById('description').value.trim();
      const duration = document.getElementById('duration').value.trim();

      try {
        const res = await fetch('/api/courses', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ title, description, duration })
        });

        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed to create course');

        showMsg('createMsg', true, 'Course created successfully!');
        document.getElementById('createCourseForm').reset();
        loadMyCourses();
      } catch (err) {
        showMsg('createMsg', false, err.message);
      }
    }

    async function loadMyCourses() {
      try {
        const res = await fetch('/api/courses', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const courses = await res.json();
        
        const myCourses = courses.filter(course => course.teacher._id === user.id);
        
        if (myCourses.length === 0) {
          document.getElementById('coursesContainer').innerHTML = '<p style="text-align: center; color: #64748b;">No courses created yet.</p>';
          return;
        }

        const html = myCourses.map((course, idx) => `
          <div class="course-card" style="animation: fadeInUp .4s ease forwards; animation-delay: ${idx*60}ms;">
            <h3>${course.title}</h3>
            <p>${course.description}</p>
            <div class="course-meta">
              <span>Duration: ${course.duration}</span>
              <span>Created: ${new Date(course.createdAt).toLocaleDateString()}</span>
            </div>
            <div class="course-actions" style="margin-top: 1rem;">
              <button class="btn btn-primary" onclick="viewStudents('${course._id}', '${course.title}')">View Students</button>
            </div>
          </div>
        `).join('');

        document.getElementById('coursesContainer').innerHTML = `<div class="courses-grid">${html}</div>`;
      } catch (err) {
        showMsg('coursesMsg', false, 'Failed to load courses');
        document.getElementById('coursesContainer').innerHTML = '<p style="text-align: center; color: #ef4444;">Error loading courses</p>';
      }
    }

    async function viewStudents(courseId, courseTitle) {
      try {
        const res = await fetch(`/api/courses/${courseId}/students`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const students = await res.json();
        
        if (!res.ok) throw new Error(students.error || 'Failed to load students');

        const modal = document.createElement('div');
        modal.style.cssText = `
          position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
          background: rgba(0,0,0,0.5); display: flex; justify-content: center; 
          align-items: center; z-index: 1000; animation: fadeIn 0.3s ease;
        `;
        
        const content = document.createElement('div');
        content.style.cssText = `
          background: white; border-radius: 12px; padding: 2rem; max-width: 600px; 
          width: 90%; max-height: 80vh; overflow-y: auto; animation: slideInUp 0.3s ease;
        `;
        
        const studentsHtml = students.length === 0 ? 
          '<p style="text-align: center; color: #64748b;">No students enrolled yet.</p>' :
          `<div class="student-list">${students.map((student, idx) => `
            <div class="student-card" style="animation: fadeInUp .4s ease forwards; animation-delay: ${idx*50}ms;">
              <h4>${student.name}</h4>
              <p>${student.email}</p>
            </div>
          `).join('')}</div>`;
        
        content.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2 style="margin: 0;">Students in "${courseTitle}"</h2>
            <button onclick="this.closest('.modal').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
          </div>
          ${studentsHtml}
        `;
        
        modal.className = 'modal';
        modal.appendChild(content);
        document.body.appendChild(modal);
        
        // Close on backdrop click
        modal.addEventListener('click', (e) => {
          if (e.target === modal) modal.remove();
        });
        
      } catch (err) {
        showMsg('coursesMsg', false, err.message);
      }
    }

    function logout() {
      localStorage.removeItem('token');
      window.location.href = '/auth-ui/login.html';
    }

    // Initialize
    if (requireAuth()) {
      document.getElementById('createCourseForm').addEventListener('submit', createCourse);
      loadMyCourses();
    }
  </script>
</body>
</html>
